name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON data files
        run: |
          echo "Validating JSON files..."
          errors=0
          while IFS= read -r f; do
            if ! python3 -c "import json, sys; json.load(open(sys.argv[1]))" "$f" 2>&1; then
              echo "FAIL: $f"
              errors=$((errors + 1))
            else
              echo "  ok: $f"
            fi
          done < <(find . -name '*.json' -not -path '*/node_modules/*')
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors JSON file(s) have syntax errors"
            exit 1
          fi
          echo "All JSON files valid."

      - name: Check JS syntax
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: |
          echo "Checking JS syntax..."
          errors=0
          while IFS= read -r f; do
            if ! node --check "$f" 2>&1; then
              echo "FAIL: $f"
              errors=$((errors + 1))
            fi
          done < <(find . -name '*.js' -o -name '*.mjs' | grep -v node_modules | grep -v 'ort.bundle' | grep -v 'transformers.min' | grep -v 'lottie.min')
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors JS file(s) have syntax errors"
            exit 1
          fi
          echo "All JS files valid."

      - name: Validate HTML structure
        run: |
          echo "Checking HTML files exist and are non-empty..."
          expected=(
            index.html
            felix/index.html
            felix/english/index.html
            felix/math/index.html
            felix/quiz-livre/index.html
            felix/stats/index.html
            zoe/app.html
            dasha/index.html
            dasha/french/index.html
            dasha/citizenship/index.html
            dasha/stats/index.html
          )
          errors=0
          for f in "${expected[@]}"; do
            if [ ! -s "$f" ]; then
              echo "MISSING or EMPTY: $f"
              errors=$((errors + 1))
            else
              echo "  ok: $f"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors expected HTML file(s) missing or empty"
            exit 1
          fi
          echo "All HTML entry points present."

      - name: Check internal asset references
        run: |
          echo "Checking for broken local references..."
          errors=0
          # Check that no JS/HTML still references old project paths
          if grep -r "felixs-games\|zoes-games" --include='*.html' --include='*.js' --include='*.css' .; then
            echo "::error::Found references to old project paths (felixs-games / zoes-games)"
            errors=$((errors + 1))
          fi
          if [ "$errors" -gt 0 ]; then
            exit 1
          fi
          echo "No stale path references found."

  smoke-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: 'Page loads', file: 'smoke-pages.mjs' }
          - { name: 'Felix Math', file: 'smoke-felix-math.mjs' }
          - { name: 'Felix English', file: 'smoke-felix-english.mjs' }
          - { name: 'Felix Quiz-Livre', file: 'smoke-felix-quizlivre.mjs' }
          - { name: 'Dasha French', file: 'smoke-dasha-french.mjs' }
          - { name: 'Dasha Citizenship', file: 'smoke-dasha-citizenship.mjs' }
          - { name: 'Zoe', file: 'smoke-zoe.mjs' }
    name: smoke / ${{ matrix.test.name }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: ${{ matrix.test.name }}
        working-directory: tests
        run: node ${{ matrix.test.file }}

  gamification-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: Run gamification / IndexedDB tests
        working-directory: tests
        run: node gamification-test.mjs

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets and credentials
        run: |
          echo "Scanning for potential secrets..."
          errors=0

          # API keys, tokens, passwords in code (not in .git)
          patterns=(
            'api[_-]?key\s*[:=]\s*["\x27][A-Za-z0-9_\-]{20,}'
            'api[_-]?token\s*[:=]\s*["\x27][A-Za-z0-9_\-]{20,}'
            'secret[_-]?key\s*[:=]\s*["\x27][A-Za-z0-9_\-]{20,}'
            'password\s*[:=]\s*["\x27][^\x27"]{8,}'
            'private[_-]?key\s*[:=]\s*["\x27][A-Za-z0-9_\-]{20,}'
            'AKIA[0-9A-Z]{16}'
            'sk-[a-zA-Z0-9]{20,}'
            'ghp_[a-zA-Z0-9]{36}'
            'glpat-[a-zA-Z0-9\-]{20,}'
          )

          for pat in "${patterns[@]}"; do
            if grep -rEin "$pat" --include='*.html' --include='*.js' --include='*.css' --include='*.json' --include='*.md' --include='*.yml' . 2>/dev/null | grep -v node_modules | grep -v '.git/' | grep -v 'shared/secrets\.js' | grep -v 'html2canvas\.min\.js'; then
              echo "::warning::Potential secret found matching pattern: $pat"
              errors=$((errors + 1))
            fi
          done

          # Check for private key files
          if find . -name '*.pem' -o -name '*.key' -o -name '*.p12' -o -name '*.pfx' | grep -v node_modules | grep -q .; then
            echo "::error::Private key files found in repository"
            errors=$((errors + 1))
          fi

          # Check for .env files
          if find . -name '.env' -o -name '.env.*' | grep -q .; then
            echo "::error::.env file found in repository"
            errors=$((errors + 1))
          fi

          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors potential secret(s) detected — review above"
            exit 1
          fi
          echo "No secrets detected."

      - name: Check for dangerous JS patterns
        run: |
          echo "Scanning for dangerous code patterns..."
          warnings=0

          # eval() usage (excluding minified bundles)
          if grep -rn 'eval\s*(' --include='*.js' --include='*.html' . | grep -v node_modules | grep -v 'ort.bundle' | grep -v 'transformers.min' | grep -v 'lottie.min' | grep -v '// safe:'; then
            echo "::warning::eval() usage detected"
            warnings=$((warnings + 1))
          fi

          # document.write
          if grep -rn 'document\.write\s*(' --include='*.js' --include='*.html' . | grep -v node_modules | grep -v 'ort.bundle' | grep -v 'transformers.min'; then
            echo "::warning::document.write() usage detected"
            warnings=$((warnings + 1))
          fi

          # innerHTML with variable interpolation (potential XSS)
          if grep -rn 'innerHTML\s*=\s*`' --include='*.js' --include='*.html' . | grep -v node_modules | grep -v 'ort.bundle' | grep -v 'transformers.min' | grep '\${'; then
            echo "::warning::innerHTML with template literal interpolation detected (potential XSS)"
            warnings=$((warnings + 1))
          fi

          if [ "$warnings" -gt 0 ]; then
            echo "::warning::$warnings potentially dangerous pattern(s) found — review above"
          fi
          echo "Security pattern scan complete."

      - name: Check HTTP security headers in nginx config
        run: |
          echo "Checking for security best practices..."
          warnings=0

          # Flag any http:// URLs in source (should be https:// or relative)
          if grep -rn 'http://' --include='*.html' --include='*.js' --include='*.css' . | grep -v node_modules | grep -v '// ' | grep -v 'localhost' | grep -v '127.0.0.1' | grep -v 'http://www.w3.org' | grep -v 'http://schemas'; then
            echo "::warning::Non-HTTPS URLs found in source files"
            warnings=$((warnings + 1))
          fi

          if [ "$warnings" -gt 0 ]; then
            echo "::warning::$warnings security warning(s) — review above"
          fi
          echo "Security checks complete."
