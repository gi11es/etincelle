name: Claude Auto-Fix

on:
  issues:
    types: [labeled]

jobs:
  fix:
    if: github.event.label.name == 'bug-report'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract issue data
        id: issue
        run: |
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          echo "number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          # Title and body go to files to avoid shell injection
          echo "$ISSUE_TITLE" > /tmp/issue_title.txt
          echo "$ISSUE_BODY" > /tmp/issue_body.txt

      - name: Ensure latest master
        run: git pull --rebase origin master

      - name: Run Claude to fix the issue
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE=$(cat /tmp/issue_title.txt)
          BODY=$(cat /tmp/issue_body.txt)

          PROMPT="You are resolving a GitHub issue for a static website (pure HTML/CSS/JS, ES modules, no bundler).
          The issue may be a bug report OR a feature request. Read CLAUDE.md first for architecture details.

          GitHub Issue #${{ steps.issue.outputs.number }}:
          Title: ${TITLE}

          Body:
          ${BODY}

          Instructions:
          - Start by reading CLAUDE.md to understand the project architecture and patterns.
          - The issue was submitted via an in-app bug widget, so the description may be in French.
          - The Page URL in the Context section tells you which page is affected.
          - Determine whether this is a bug fix or a feature request.

          For BUG FIXES:
          - Read the relevant files, understand the issue, and make the minimal fix.
          - Identify and fix the ROOT CAUSE. Do not add workarounds, timeouts, or fallbacks that mask the problem.
          - If the issue mentions mobile or WASM, read the Known Gotchas section in CLAUDE.md.
          - Before starting, search closed issues for prior fix attempts: gh issue list --state closed --search '<keywords>' --limit 10. If a previous fix exists for the same problem, take a DIFFERENT approach.
          - Only change what is necessary.

          For FEATURE REQUESTS (new game, new activity, new section, new content):
          - Study at least one existing similar feature in the same file to understand the patterns before building.
          - Implement the feature FULLY end-to-end ‚Äî data, UI, logic, navigation, and user interaction.
          - The feature must be usable and complete when you are done. Do not just add data without wiring up the UI and game logic.
          - Follow the existing patterns exactly (see CLAUDE.md for per-portal architecture).

          General:
          - Do NOT add comments, docstrings, or unrelated improvements.
          - Do NOT modify files in .github/ ‚Äî changes there are excluded from commits and will be lost.
          - After making your changes, write a short English summary (under 60 chars, no quotes) of what you did to a file called /tmp/fix_summary.txt. Example: Add color-matching game for Zoe portal"

          claude --print --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 40 \
            "$PROMPT"

      - name: Read fix summary
        id: summary
        run: |
          if [ -f /tmp/fix_summary.txt ]; then
            SUMMARY=$(head -1 /tmp/fix_summary.txt | cut -c1-60)
            echo "title=$SUMMARY" >> "$GITHUB_OUTPUT"
          else
            echo "title=Auto-fix by Claude" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard -- . ':!.github')" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment if no changes
        if: steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.issue.outputs.number }} \
            --body "Claude analyzed this issue but could not produce a code fix automatically. A human will need to take a look."

      - name: Create fix branch and commit
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          BRANCH="claude-fix/issue-${{ steps.issue.outputs.number }}"
          git config user.name "claude-bot"
          git config user.email "claude-bot@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A -- . ':!.github'
          SUMMARY="${{ steps.summary.outputs.title }}"
          git commit -m "Fix #${{ steps.issue.outputs.number }}: $SUMMARY

          Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"
          git push origin "$BRANCH"

      - name: Create dummy secrets for tests
        if: steps.changes.outputs.has_changes == 'true'
        run: cp shared/secrets.example.js shared/secrets.js

      - name: Run validation tests
        if: steps.changes.outputs.has_changes == 'true'
        id: validate
        continue-on-error: true
        run: |
          echo "Validating JSON files..."
          errors=0
          while IFS= read -r f; do
            if ! python3 -c "import json, sys; json.load(open(sys.argv[1]))" "$f" 2>&1; then
              echo "FAIL: $f"
              errors=$((errors + 1))
            fi
          done < <(find . -name '*.json' -not -path '*/node_modules/*')
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors JSON file(s) have syntax errors"
            exit 1
          fi

          echo "Checking JS syntax..."
          while IFS= read -r f; do
            if ! node --check "$f" 2>&1; then
              echo "FAIL: $f"
              errors=$((errors + 1))
            fi
          done < <(find . -name '*.js' -o -name '*.mjs' | grep -v node_modules | grep -v 'ort.bundle' | grep -v 'transformers.min' | grep -v 'lottie.min')
          if [ "$errors" -gt 0 ]; then
            echo "::error::$errors JS file(s) have syntax errors"
            exit 1
          fi

      - name: Run smoke tests
        if: steps.changes.outputs.has_changes == 'true'
        id: smoke
        continue-on-error: true
        working-directory: tests
        run: |
          npm ci
          FAILED=0
          for test_file in smoke-*.mjs; do
            echo "Running $test_file..."
            if ! node "$test_file"; then
              echo "FAIL: $test_file"
              FAILED=$((FAILED + 1))
            fi
          done
          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED smoke test(s) failed"
            exit 1
          fi

      - name: Determine test result
        if: steps.changes.outputs.has_changes == 'true'
        id: tests
        run: |
          if [ "${{ steps.validate.outcome }}" = "success" ] && [ "${{ steps.smoke.outcome }}" = "success" ]; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR (tests passed) and merge
        if: steps.changes.outputs.has_changes == 'true' && steps.tests.outputs.passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="claude-fix/issue-${{ steps.issue.outputs.number }}"
          PR_URL=$(gh pr create \
            --base master \
            --head "$BRANCH" \
            --title "Fix #${{ steps.issue.outputs.number }}: ${{ steps.summary.outputs.title }}" \
            --body "Automated fix for #${{ steps.issue.outputs.number }}.

          Fixes #${{ steps.issue.outputs.number }}

          All tests passed ‚Äî merging automatically.

          ü§ñ Generated by Claude Opus 4.6")

          gh pr merge "$PR_URL" --merge --delete-branch

      - name: Create PR (tests failed)
        if: steps.changes.outputs.has_changes == 'true' && steps.tests.outputs.passed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="claude-fix/issue-${{ steps.issue.outputs.number }}"
          PR_URL=$(gh pr create \
            --base master \
            --head "$BRANCH" \
            --title "Fix #${{ steps.issue.outputs.number }}: ${{ steps.summary.outputs.title }} (needs review)" \
            --body "Automated fix attempt for #${{ steps.issue.outputs.number }}.

          ‚ö†Ô∏è **Tests failed** ‚Äî this PR needs manual review before merging.

          ü§ñ Generated by Claude Opus 4.6")

          gh issue comment ${{ steps.issue.outputs.number }} \
            --body "Claude produced a fix but some tests failed. PR created for manual review: $PR_URL"
